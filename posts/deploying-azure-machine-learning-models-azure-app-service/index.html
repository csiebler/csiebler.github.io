<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>Deploying Azure Machine Learning Models to Azure App Service &#183; Clemens Siebler's Blog</title>
<meta name=title content="Deploying Azure Machine Learning Models to Azure App Service &#183; Clemens Siebler's Blog"><script type=text/javascript src=/js/appearance.min.74ad8406faea02f3e186ba5126249aaeed9073629e04b05037b903396b188724.js integrity="sha256-dK2EBvrqAvPhhrpRJiSaru2Qc2KeBLBQN7kDOWsYhyQ="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.7c1e6d40b23627ab31090b2d8fcdf80392861650296ac97e1d0d4d184dee1930.css integrity="sha256-fB5tQLI2J6sxCQstj834A5KGFlApasl+HQ1NGE3uGTA="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.3e80d0528c59616e7de9b0ca9316d9afd314b49ed9e5e6b88873731486ad67ee.js integrity="sha256-PoDQUoxZYW596bDKkxbZr9MUtJ7Z5ea4iHNzFIatZ+4=" data-copy=Copy data-copied=Copied></script><meta name=description content="
      
        
      
    "><link rel=canonical href=https://clemenssiebler.com/posts/deploying-azure-machine-learning-models-azure-app-service/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://clemenssiebler.com/posts/deploying-azure-machine-learning-models-azure-app-service/"><meta property="og:site_name" content="Clemens Siebler's Blog"><meta property="og:title" content="Deploying Azure Machine Learning Models to Azure App Service"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-05T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploying Azure Machine Learning Models to Azure App Service"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Deploying Azure Machine Learning Models to Azure App Service","headline":"Deploying Azure Machine Learning Models to Azure App Service","inLanguage":"en","url":"https:\/\/clemenssiebler.com\/posts\/deploying-azure-machine-learning-models-azure-app-service\/","author":{"@type":"Person","name":""},"copyrightYear":"2021","dateCreated":"2021-05-05T00:00:00\u002b00:00","datePublished":"2021-05-05T00:00:00\u002b00:00","dateModified":"2021-05-05T00:00:00\u002b00:00","mainEntityOfPage":"true","wordCount":"1387"}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-HB3D5YJ128"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-HB3D5YJ128")}</script></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 print:hidden sm:py-10 dark:text-neutral"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Clemens Siebler&rsquo;s Blog</a></div><ul class="flex list-none flex-col text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/posts/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/talks/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Talks</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/about/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">About</span></a></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Deploying Azure Machine Learning Models to Azure App Service</h1><div class="mb-12 mt-8 text-base text-neutral-500 print:hidden dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-05-05 00:00:00 +0000 UTC">5 May 2021</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">7 mins</span></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#getting-started>Getting Started</a></li><li><a href=#packaging-our-model-for-deployment>Packaging our model for deployment</a></li><li><a href=#running-the-model-locally>Running the model locally</a></li><li><a href=#adding-model-telemetry-logging>Adding model telemetry logging</a></li><li><a href=#adding-model-data-collection>Adding model data collection</a></li><li><a href=#deployment-to-azure-app-service>Deployment to Azure App Service</a></li><li><a href=#next-steps>Next Steps</a></li><li><a href=#summary>Summary</a></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><h2 id=introduction class="relative group">Introduction <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#introduction aria-label=Anchor>#</a></span></h2><p>This post will explain deploying Azure Machine Learning models to Azure App Service. This allows for easier model deployments, especially for those users who do not want to deploy to e.g., Azure Kubernetes Service. In this post, we will follow the proposed approach from the <a href=https://docs.microsoft.com/en-us/azure/machine-learning/how-to-deploy-app-service target=_blank rel=noreferrer>official documentation</a> to a certain degree, but we will also add model telemetry/metrics logging and <a href=https://docs.microsoft.com/en-us/azure/machine-learning/how-to-enable-data-collection target=_blank rel=noreferrer>Model Data Collection</a>. This allows for a &lsquo;more complete&rsquo; approach of model deployment with model monitoring over just running a plain Docker container on App Service.</p><p>Overall, this example can be reused to deploy the Docker images generated by Azure Machine Learning to any platform that is capable of running Docker images.</p><p><figure><img src=/images/app_service_model_deployment_architecture.png alt="Deployment Architecture" class="mx-auto my-0 rounded-md"><figcaption class=text-center>Deployment Architecture</figcaption></figure></p><p>If we look at the architecture diagram above, we&rsquo;ll focus on the following steps in this post:</p><ul><li>Packaging the model as a Docker image</li><li>Deploying the image to App Service</li><li>Adding model telemetry logging to Application Insights</li><li>Adding model data collection to Azure Blob</li><li>Consuming the model using its exposed API</li></ul><h2 id=getting-started class="relative group">Getting Started <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#getting-started aria-label=Anchor>#</a></span></h2><p>To get started, we assume that we already have:</p><ul><li>a registered model in Azure Machine Learning</li><li>a score.py scoring script with model data collection enabled (example: <a href=https://github.com/csiebler/mlops-demo/blob/master/models/german-credit-basic/score.py target=_blank rel=noreferrer><code>score.py</code></a>)</li><li>a conda.yml with your model dependencies (example: <a href=https://github.com/csiebler/mlops-demo/blob/master/models/german-credit-basic/config/inference-conda.yml target=_blank rel=noreferrer><code>conda.yml</code></a>)
In short, you already have taken the steps to train and deploy a model.</li></ul><h2 id=packaging-our-model-for-deployment class="relative group">Packaging our model for deployment <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#packaging-our-model-for-deployment aria-label=Anchor>#</a></span></h2><p>First, we want to package our existing model using the registered model, our scoring script and our Conda environment:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>azureml.core</span> <span class=kn>import</span> <span class=n>Workspace</span><span class=p>,</span> <span class=n>Model</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>azureml.core.model</span> <span class=kn>import</span> <span class=n>InferenceConfig</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>azureml.core.environment</span> <span class=kn>import</span> <span class=n>Environment</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>azureml.core.conda_dependencies</span> <span class=kn>import</span> <span class=n>CondaDependencies</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ws</span> <span class=o>=</span> <span class=n>Workspace</span><span class=o>.</span><span class=n>from_config</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>env</span> <span class=o>=</span> <span class=n>Environment</span><span class=p>(</span><span class=s2>&#34;inference-env&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>env</span><span class=o>.</span><span class=n>docker</span><span class=o>.</span><span class=n>enabled</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=c1># Replace with your conda enviroment file</span>
</span></span><span class=line><span class=cl><span class=n>env</span><span class=o>.</span><span class=n>python</span><span class=o>.</span><span class=n>conda_dependencies</span> <span class=o>=</span> <span class=n>CondaDependencies</span><span class=p>(</span><span class=s2>&#34;./conda.yml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Replace with your score.py</span>
</span></span><span class=line><span class=cl><span class=n>inference_config</span> <span class=o>=</span> <span class=n>InferenceConfig</span><span class=p>(</span><span class=n>entry_script</span><span class=o>=</span><span class=s2>&#34;score.py&#34;</span><span class=p>,</span> <span class=n>environment</span><span class=o>=</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Replace with your model</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>Model</span><span class=p>(</span><span class=n>ws</span><span class=p>,</span> <span class=s1>&#39;my-model&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>package</span> <span class=o>=</span> <span class=n>Model</span><span class=o>.</span><span class=n>package</span><span class=p>(</span><span class=n>ws</span><span class=p>,</span> <span class=p>[</span><span class=n>model</span><span class=p>],</span> <span class=n>inference_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>package</span><span class=o>.</span><span class=n>wait_for_creation</span><span class=p>(</span><span class=n>show_output</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Packaged model image: </span><span class=si>{</span><span class=n>package</span><span class=o>.</span><span class=n>location</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>The code will return the URL to the new Docker image:</p><pre tabindex=0><code>Packaged model image: amldemowexxxxxx.azurecr.io/package@sha256:e755bb6db2e75f66c5ddcd357b111f2d4axxxxxxxxxxxxxxxx
</code></pre><p>Now that we have the model image built, we can start deploying it to a Docker runtime. If you need a more customized Docker image (e.g., maybe you are required to add a few more complex dependencies), you can follow the tutorial from the last post on <a href=https://clemenssiebler.com/azure-machine-learning-custom-images/ target=_blank rel=noreferrer>building custom Docker images</a>.</p><h2 id=running-the-model-locally class="relative group">Running the model locally <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#running-the-model-locally aria-label=Anchor>#</a></span></h2><p>Next, we can try running the model locally on our laptop, Compute Instance or where ever you have Docker running. For this, we log in to the Azure Container Registry where our model image has been stored:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>docker login amldemowexxxxxx.azurecr.io
</span></span></span></code></pre></div><p>You can easily retrieve the login credentials for the Container Registry through the Azure Portal:</p><p><figure><img src=/images/container_registry_login.png alt="Container Registry details" class="mx-auto my-0 rounded-md"><figcaption class=text-center>Container Registry details</figcaption></figure></p><p>From here, we can run the image via Docker by forwarding web service port 5001 to the host:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>docker run -it --rm \
</span></span></span><span class=line><span class=cl><span class=go>-p 5001:5001 \
</span></span></span><span class=line><span class=cl><span class=go>amldemowexxxxxx.azurecr.io/package@sha256:e755bb6db2e75f66c5ddcd357b111f2d4axxxxxxxxxxxxxxxx
</span></span></span></code></pre></div><p>And then quickly test if we can call the model successfully:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span><span class=o>,</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test_sample</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=p>[{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Age&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Sex&#34;</span><span class=p>:</span> <span class=s2>&#34;male&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Job&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Housing&#34;</span><span class=p>:</span> <span class=s2>&#34;own&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Saving accounts&#34;</span><span class=p>:</span> <span class=s2>&#34;little&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Checking account&#34;</span><span class=p>:</span> <span class=s2>&#34;little&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Credit amount&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Duration&#34;</span><span class=p>:</span> <span class=mi>48</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Purpose&#34;</span><span class=p>:</span> <span class=s2>&#34;radio/TV&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://localhost:5001/score&#34;</span>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span><span class=s1>&#39;application/json&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>test_sample</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></div><p>Which in our case here, returns the HTTP response code and the mode&rsquo;s predictions:</p><pre tabindex=0><code>200
{&#34;predict_proba&#34;: [[0.6900664207902661, 0.30993357920973386]]}
</code></pre><p>Perfect, our model is up and running, next we&rsquo;ll add some telemetry logging to Application Insights.</p><h2 id=adding-model-telemetry-logging class="relative group">Adding model telemetry logging <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#adding-model-telemetry-logging aria-label=Anchor>#</a></span></h2><p>Next, we can add model telemetry logging to Application Insights. We can achieve this by setting the appropriate logging-related environment variables in our Docker command:</p><ul><li><code>AML_APP_INSIGHTS_ENABLED=true</code></li><li><code>AML_APP_INSIGHTS_KEY=&lt;Instrumentation key></code></li><li><code>WORKSPACE_NAME=&lt;Name of your Workspace></code></li><li><code>SERVICE_NAME=&lt;arbitrary service name, e.g. deployment name or build Id></code></li></ul><p>You can retrieve the Instrumentation key for Application Insights from the Azure Portal:</p><p><figure><img src=/images/application_insights_key.png alt="Application Insights key" class="mx-auto my-0 rounded-md"><figcaption class=text-center>Retrieving our Application Insights key</figcaption></figure></p><p>Adding those to our Docker command should look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>docker run -it --rm \
</span></span></span><span class=line><span class=cl><span class=go>-e WORKSPACE_NAME=aml-demo-we \
</span></span></span><span class=line><span class=cl><span class=go>-e SERVICE_NAME=build12345 \
</span></span></span><span class=line><span class=cl><span class=go>-e AML_APP_INSIGHTS_ENABLED=true \
</span></span></span><span class=line><span class=cl><span class=go>-e AML_APP_INSIGHTS_KEY=1f224928-xxxx-xxxx-xxxx-xxxxxxxxx \
</span></span></span><span class=line><span class=cl><span class=go>-p 5001:5001 \
</span></span></span><span class=line><span class=cl><span class=go>amldemowexxxxxx.azurecr.io/package@sha256:e755bb6db2e75f66c5ddcd357b111f2d4axxxxxxxxxxxxxxxx
</span></span></span></code></pre></div><p>Now, once we run the model and send some data to it, we should see it popping up in Application Insights by going to &ldquo;Log Analytics&rdquo; and querying for <code>requests</code>:</p><p><figure><img src=/images/requests_in_app_insights.png alt="Requests in Application Insights" class="mx-auto my-0 rounded-md"><figcaption class=text-center>Our requests in Application Insights</figcaption></figure></p><p>Alternatively, we can also query by traces, which will show us STDOUT/STDERR of our model&rsquo;s code that is running the Docker container:</p><p><figure><img src=/images/traces_in_application_insights.png alt="Traces in Application Insights" class="mx-auto my-0 rounded-md"><figcaption class=text-center>Our traces in Application Insights</figcaption></figure></p><p>Great, now we have our model running and it is reporting back its STDOUT/STDERR and its predictions to Application Insights. Next, we will also add model data collection, to push model input and prediction data back to Azure Blob Storage.</p><h2 id=adding-model-data-collection class="relative group">Adding model data collection <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#adding-model-data-collection aria-label=Anchor>#</a></span></h2><p>Lastly, we can add model data collection to our model. For this, we first need to have a storage account with a container called modeldata. In this case, we can just create the container using the Azure Portal:</p><p><figure><img src=/images/create_container.png alt="New Blob Container" class="mx-auto my-0 rounded-md"><figcaption class=text-center>Creating a new Blob container for our data collection</figcaption></figure></p><p>Next, we need to set the Model Data Collection related environment variables:</p><ul><li><code>AML_MODEL_DC_STORAGE_ENABLED=true</code></li><li><code>AML_MODEL_DC_STORAGE=&lt;Storage Connection String></code></li></ul><p>In this case, <code>AML_MODEL_DC_STORAGE</code> refers to the connection string to your Storage Account. With this, we can re-run our Docker container with the appropriate parameters set:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>docker run -it --rm \
</span></span></span><span class=line><span class=cl><span class=go>-e WORKSPACE_NAME=aml-demo-we \
</span></span></span><span class=line><span class=cl><span class=go>-e SERVICE_NAME=build2542 \
</span></span></span><span class=line><span class=cl><span class=go>-e AML_APP_INSIGHTS_ENABLED=true \
</span></span></span><span class=line><span class=cl><span class=go>-e AML_APP_INSIGHTS_KEY=123445-1234-1234-1234-12345667889 \
</span></span></span><span class=line><span class=cl><span class=go>-e AML_MODEL_DC_STORAGE_ENABLED=true \
</span></span></span><span class=line><span class=cl><span class=go>-e AML_MODEL_DC_STORAGE=&#34;DefaultEndpointsProtocol=https;AccountName=xxxxxx;AccountKey=xxxxxxxxx;EndpointSuffix=core.windows.net&#34; \
</span></span></span><span class=line><span class=cl><span class=go>-p 5001:5001 \
</span></span></span><span class=line><span class=cl><span class=go>amldemowexxxxxx.azurecr.io/package@sha256:e755bb6db2e75f66c5ddcd357b111f2d4axxxxxxxxxxxxxxxx
</span></span></span></code></pre></div><p>After a while (it is currently unclear to me how long this takes), our model input and prediction data will show up in our modeldata container in Blob:</p><p><figure><img src=/images/data_collection_storage_account.png alt="Data Collection working" class="mx-auto my-0 rounded-md"><figcaption class=text-center>Our data collection is working</figcaption></figure></p><p>From here, we can finally start deploying the model to App Service.</p><h2 id=deployment-to-azure-app-service class="relative group">Deployment to Azure App Service <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#deployment-to-azure-app-service aria-label=Anchor>#</a></span></h2><p>First, let&rsquo;s create an new App Service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>az group create --name app-service-deployment --location &#34;West Europe&#34;
</span></span></span><span class=line><span class=cl><span class=go>az appservice plan create --name models --resource-group app-service-deployment --sku B1 --is-linux
</span></span></span></code></pre></div><p>Next, let&rsquo;s deploy our container to the App Service (it won&rsquo;t pull the image yet as we first need to add authentication to our Container Registry):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>az webapp create --resource-group app-service-deployment --plan models --name model1-blog-demo --deployment-container-image-name amldemowexxxxxx.azurecr.io/package@sha256:e755bb6db2e75f66c5ddcd357b111f2d4axxxxxxxxxxxxxxxx
</span></span></span></code></pre></div><p>Next, let&rsquo;s add the Managed Identity of our new app to the Container Registry, so it can pull the image:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>#</span> Assign Managed Identity to our Web App
</span></span><span class=line><span class=cl><span class=go>az webapp identity assign --resource-group app-service-deployment --name model1-blog-demo --query principalId --output tsv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span> Query the resource id of our Container Registry
</span></span><span class=line><span class=cl><span class=go>az acr show -g aml-demo-we -n amldemowexxxxxx --query id --output tsv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span> Assign Pull permission of our Web App to our Container Registry
</span></span><span class=line><span class=cl><span class=go>az role assignment create --assignee &lt;id from first command&gt; --scope &lt;output from second command&gt; --role &#34;AcrPull&#34;
</span></span></span></code></pre></div><p>Next, we can add the port mapping and our environment variables:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>az webapp config appsettings set --resource-group app-service-deployment --name model1-blog-demo --settings WEBSITES_PORT=5001
</span></span></span><span class=line><span class=cl><span class=go>az webapp config appsettings set --name model1-blog-demo --resource-group app-service-deployment --settings WORKSPACE_NAME=&#34;aml-demo-we&#34;
</span></span></span><span class=line><span class=cl><span class=go>az webapp config appsettings set --name model1-blog-demo --resource-group app-service-deployment --settings SERVICE_NAME=&#34;build12345&#34;
</span></span></span><span class=line><span class=cl><span class=go>az webapp config appsettings set --name model1-blog-demo --resource-group app-service-deployment --settings AML_APP_INSIGHTS_ENABLED=&#34;true&#34;
</span></span></span><span class=line><span class=cl><span class=go>az webapp config appsettings set --name model1-blog-demo --resource-group app-service-deployment --settings AML_APP_INSIGHTS_KEY=&#34;123445-1234-1234-1234-12345667889&#34;
</span></span></span><span class=line><span class=cl><span class=go>az webapp config appsettings set --name model1-blog-demo --resource-group app-service-deployment --settings AML_MODEL_DC_STORAGE_ENABLED=&#34;true&#34;
</span></span></span><span class=line><span class=cl><span class=go>az webapp config appsettings set --name model1-blog-demo --resource-group app-service-deployment --settings AML_MODEL_DC_STORAGE=&#34;DefaultEndpointsProtocol=https;AccountName=xxxxx;AccountKey=xxxxxxxx;EndpointSuffix=core.windows.net&#34;
</span></span></span></code></pre></div><p>Lastly, let&rsquo;s restart our app so it pulls the new settings:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>az webapp restart --resource-group app-service-deployment --name model1-blog-demo
</span></span></span></code></pre></div><p>From here, we can finally call our endpoint (same code as above) using <a href=https://model1-blog-demo.azurewebsites.net target=_blank rel=noreferrer>https://model1-blog-demo.azurewebsites.net</a>. After a few minutes, our telemetry metrics and data collection should start to kick in show our model&rsquo;s telemetry in Azure.</p><h2 id=next-steps class="relative group">Next Steps <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#next-steps aria-label=Anchor>#</a></span></h2><p>As a last step, we should consider two open points: authentication and automation.</p><p>Firstly, we will need to enable <a href=https://docs.microsoft.com/en-us/azure/app-service/configure-authentication-provider-aad target=_blank rel=noreferrer>authentication via an identity provider</a> for our deployed model. The web app is per default publicly exposed and by using e.g., Azure Active Directory, we can force the model consumers to authenticate. Furthermore, we can use the rich networking settings on App Service to further lock down the service if desired.</p><p>Secondly, we obviously should use some form of Continuous Deployment to automate the deployment steps. This can be fairly easily done by using the commands provided in this post and putting them into a CI/CD pipeline of your choice, e.g. in Azure DevOps or GitHub Actions.</p><h2 id=summary class="relative group">Summary <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#summary aria-label=Anchor>#</a></span></h2><p>This post gave a short overview how to packages models to Docker images in Azure Machine Learning. From there, we discussed options how to capture model telemetry and also enable model data collection. With this, we can now deploy models easily to various platform, such as Azure App Service, while still receiving logs in Application Insights and data in Azure Blob.</p></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://clemenssiebler.com/posts/deploying-azure-machine-learning-models-azure-app-service/&amp;quote=Deploying%20Azure%20Machine%20Learning%20Models%20to%20Azure%20App%20Service" title="Share on Facebook" aria-label="Share on Facebook" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://clemenssiebler.com/posts/deploying-azure-machine-learning-models-azure-app-service/&amp;text=Deploying%20Azure%20Machine%20Learning%20Models%20to%20Azure%20App%20Service" title="Tweet on Twitter" aria-label="Tweet on Twitter" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://pinterest.com/pin/create/bookmarklet/?url=https://clemenssiebler.com/posts/deploying-azure-machine-learning-models-azure-app-service/&amp;description=Deploying%20Azure%20Machine%20Learning%20Models%20to%20Azure%20App%20Service" title="Pin on Pinterest" aria-label="Pin on Pinterest" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M496 256c0 137-111 248-248 248-25.6.0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8.0 128.7-68.8 128.7-154.3.0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1.0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6.0-54.7 41.4-107.6 112-107.6 60.9.0 103.6 41.5 103.6 100.9.0 67.1-33.9 113.6-78 113.6-24.3.0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6.0-19-10.2-34.9-31.4-34.9-24.9.0-44.9 25.7-44.9 60.2.0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9.0 361.1.0 256 0 119 111 8 248 8s248 111 248 248z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://clemenssiebler.com/posts/deploying-azure-machine-learning-models-azure-app-service/&amp;resubmit=true&amp;title=Deploying%20Azure%20Machine%20Learning%20Models%20to%20Azure%20App%20Service" title="Submit to Reddit" aria-label="Submit to Reddit" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://clemenssiebler.com/posts/deploying-azure-machine-learning-models-azure-app-service/&amp;title=Deploying%20Azure%20Machine%20Learning%20Models%20to%20Azure%20App%20Service" title="Share on LinkedIn" aria-label="Share on LinkedIn" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://clemenssiebler.com/posts/deploying-azure-machine-learning-models-azure-app-service/&amp;subject=Deploying%20Azure%20Machine%20Learning%20Models%20to%20Azure%20App%20Service" title="Send via email" aria-label="Send via email" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/azure-machine-learning-custom-images/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Azure Machine Learning Custom Images (for Advanced Scenarios)</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-05-03 00:00:00 +0000 UTC">3 May 2021</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/enforcing-init-scripts-on-azure-machine-learning-compute-instances/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Enforcing Init Scripts on Azure Machine Learning Compute Instances</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-07-19 00:00:00 +0000 UTC">19 July 2021</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".prose img"));images.forEach(e=>{mediumZoom(e,{margin:5,scrollOffset:40,container:null,template:null})})</script></footer></div></body></html>